pipeline {
    agent any
    environment {
        GITHUB_TOKEN = credentials('github-token') // ID des identifiants GitHub dans Jenkins
    }
    stages {
        stage('Checkout Code') {
            steps {
                // Cloner le code source depuis GitHub
                checkout scm
            }
        }
        stage('Install Playwright') {
            steps {
                // Installer Playwright avec la commande demandée
                bat '''
                    npm init playwright@latest --yes --quiet --browser=chromium --browser=firefox --browser=webkit --gha
                '''
            }
        }
        stage('Install Dependencies') {
            steps {
                // Installer les dépendances
                bat 'npm install'
            }
        }
        stage('Run Playwright Tests') {
            steps {
                // Exécuter les tests Playwright
                bat 'npx playwright test'
            }
        }
        // stage('Publish Test Results') {
        //     steps {
        //         // Publier les rapports JUnit
        //         junit '**/test-results/*.xml'
        //     }
        // }
        // stage('Publish HTML Report') {
        //     steps {
        //         // Publier le rapport HTML généré par Playwright
        //         publishHTML(target: [
        //             reportDir: 'playwright-report',
        //             reportFiles: 'index.html',
        //             reportName: 'Playwright Test Report',
        //             alwaysLinkToLastBuild: true,
        //             keepAll: true
        //         ])
        //     }
        // }
    }
    post {
        always {
            archiveArtifacts artifacts: 'playwright-report/**', fingerprint: true
            junit 'playwright-report/results.xml'

            publishHTML(target: [
                reportName: 'Playwright Test Report',
                reportDir: 'playwright-report',
                reportFiles: 'index.html'
            ])
        }

        failure {
            mail to: 'amal.khemiri5@gmail.com', 
                 subject: "Build #${env.BUILD_NUMBER} Failed", 
                 body: "The build has failed. Please check the Jenkins console output for more details: ${env.BUILD_URL}"
        }
    }
}
